<!DOCTYPE html>
<html lang="en-gb">
    <head>
      <meta charset="UTF-8">
      <meta name="apple-mobile-web-app-capable" content="yes">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="
    Let&#x27;s make a stupid full text search engine
">
      <meta name="author" content="Konstantin Matsiushonak">
      <title>Konstantin Matsiushonak: a journey into programming</title>
      <link rel="stylesheet" href="https://kakoc.blog/site.css" />
      <link rel="shortcut icon" type="image/png" href="https://kakoc.blog/favicon.ico"/>
      <link href="https://kakoc.blog/rss.xml" rel="feed" type="application/rss+xml" title="Konstantin Matsiushonak: a journey into programming" />
        <!-- <script> -->
        <!--   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ -->
        <!--   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), -->
        <!--   m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) -->
        <!--   })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); -->

        <!--   ga('create', 'UA-43335571-2', 'auto'); -->
        <!--   ga('send', 'pageview'); -->
        <!-- </script> -->
    </head>

    <header id="header">
        <h1 class="logo"><a href="/">kakoc_blog</a></h1>
        <ul>
            <li><a href="/blog/">Blog</a></li>
        </ul>
    </header>

    <div id="content">
        
    <div class="post">
        <div class="post__title">
            <h1>MYOX: full text search engine</h1>
            <div class="post__meta">
                2020-08-15
                
            </div>
            <hr />
        </div>

        <div class="post__body">
            <h1 id="full-text-search-engine">Full Text Search Engine<a class="zola-anchor" href="#full-text-search-engine" aria-label="Anchor link for: full-text-search-engine">ðŸ”—</a></h1>
<p>Suppose you are building an online store and you want to give to customers an ability to search against goods.<br />
How are you going to implement it?</p>
<h2 id="preparations">Preparations<a class="zola-anchor" href="#preparations" aria-label="Anchor link for: preparations">ðŸ”—</a></h2>
<p>Let's implement a stupid page where our potential user searches.</p>
<p>Firstly, let's install all needed packages for that.</p>
<pre data-lang="bash" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#5597d6;">$</span><span> cargo install wasm-pack          </span><span style="color:#7f8989;"># Compile Rust to Wasm and generate JS interop code
</span><span style="color:#5597d6;">$</span><span> cargo install cargo-make         </span><span style="color:#7f8989;"># Task runner
</span><span style="color:#5597d6;">$</span><span> cargo add wasm-bindgen           </span><span style="color:#7f8989;"># glue for Rust -&gt; WASM, WASM &lt;- Rust
</span><span style="color:#5597d6;">$</span><span> cargo add yew                    </span><span style="color:#7f8989;"># Rust -&gt; Wasm frontend framework
</span><span style="color:#5597d6;">$</span><span> cargo add instant                </span><span style="color:#7f8989;"># needs for request&#39;s time measurement
</span><span style="color:#5597d6;">$</span><span> cargo add http                   </span><span style="color:#7f8989;"># make requests from ui
</span><span style="color:#5597d6;">$</span><span> cargo add serde                  </span><span style="color:#7f8989;"># [de]serialization
</span><span style="color:#5597d6;">$</span><span> cargo add serde_json             </span><span style="color:#7f8989;"># json [de]serialization
</span><span style="color:#5597d6;">$</span><span> cargo add anyhow                 </span><span style="color:#7f8989;"># flexible errors
</span><span style="color:#5597d6;">$</span><span> cargo add rocket                 </span><span style="color:#7f8989;"># server framework
</span><span style="color:#5597d6;">$</span><span> cargo add rocket-contrib         </span><span style="color:#7f8989;"># useful things for rocket such as static serving
</span><span style="color:#5597d6;">$</span><span> cargo add csv                    </span><span style="color:#7f8989;"># parse csv files
</span><span style="color:#5597d6;">$</span><span> cargo add regex                  </span><span style="color:#7f8989;"># -..-
</span></code></pre>
<p>Now lets open <strong>Cargo.toml</strong> file and modify it a little bit:</p>
<pre data-lang="toml" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-toml "><code class="language-toml" data-lang="toml"><span>[</span><span style="color:#6486ab;">lib</span><span>]
</span><span style="color:#7f902a;">crate-type </span><span>= [</span><span style="color:#d07711;">&quot;cdylib&quot;</span><span>, </span><span style="color:#d07711;">&quot;rlib&quot;</span><span>]    </span><span style="color:#7f8989;"># for WASM
</span><span style="color:#7f902a;">name </span><span>= </span><span style="color:#d07711;">&quot;myox_ftse_lib&quot;
</span><span style="color:#7f902a;">path </span><span>= </span><span style="color:#d07711;">&quot;src/lib.rs&quot;
</span><span>
</span><span>[[</span><span style="color:#6486ab;">bin</span><span>]]
</span><span style="color:#7f902a;">name </span><span>= </span><span style="color:#d07711;">&quot;myox_ftse&quot;
</span><span style="color:#7f902a;">path </span><span>= </span><span style="color:#d07711;">&quot;src/bin.rs&quot;
</span><span>
</span><span style="color:#7f8989;"># --//--
</span><span style="color:#7f8989;"># [dependencies]
</span><span style="color:#7f8989;"># --//--
</span><span style="color:#7f8989;"># time measurement in WASM
</span><span style="color:#7f902a;">instant </span><span>= { </span><span style="color:#7f902a;">version </span><span>= </span><span style="color:#d07711;">&quot;0.1.6&quot;</span><span>, </span><span style="color:#7f902a;">features </span><span>= [ </span><span style="color:#d07711;">&quot;wasm-bindgen&quot;</span><span>, </span><span style="color:#d07711;">&quot;now&quot; </span><span>] }</span><span style="background-color:#562d56bf;color:#f8f8f8;"> </span><span>
</span></code></pre>
<p>The second step is to create a job which will be used for UI building.
Lets create a <strong>Makefile.toml</strong> in the project root(it was token from the perfect article: <a href="http://www.sheshbabu.com/posts/rust-wasm-yew-single-page-application/">introduction into yew</a>):</p>
<pre data-lang="toml" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-toml "><code class="language-toml" data-lang="toml"><span style="color:#7f8989;"># Every change in our code will trigger ui project rebuilding
</span><span style="color:#7f8989;"># so that we don&#39;t need to do it manually.
</span><span style="color:#7f8989;"># All asssets will be stored in myox_ftse/static/
</span><span>[</span><span style="color:#6486ab;">tasks.build</span><span>]
</span><span style="color:#7f902a;">command </span><span>= </span><span style="color:#d07711;">&quot;wasm-pack&quot;
</span><span style="color:#7f902a;">args </span><span>= [</span><span style="color:#d07711;">&quot;build&quot;</span><span>, </span><span style="color:#d07711;">&quot;--dev&quot;</span><span>, </span><span style="color:#d07711;">&quot;--target&quot;</span><span>, </span><span style="color:#d07711;">&quot;web&quot;</span><span>, </span><span style="color:#d07711;">&quot;--out-name&quot;</span><span>, </span><span style="color:#d07711;">&quot;wasm&quot;</span><span>, </span><span style="color:#d07711;">&quot;--out-dir&quot;</span><span>, </span><span style="color:#d07711;">&quot;./static&quot;</span><span>]
</span><span style="color:#7f902a;">watch </span><span>= { </span><span style="color:#7f902a;">ignore_pattern </span><span>= </span><span style="color:#d07711;">&quot;static/*&quot; </span><span>}
</span></code></pre>
<h1 id="let-s-code-a-ui">Let's code a UI<a class="zola-anchor" href="#let-s-code-a-ui" aria-label="Anchor link for: let-s-code-a-ui">ðŸ”—</a></h1>
<p>All ui will be stored in the single(ui.rs) file.</p>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#7f8989;">// src/lib.rs
</span><span style="color:#668f14;">mod </span><span style="color:#c23f31;">ui</span><span>;
</span></code></pre>
<p>I won't give many comments about UI part, there is a great article about that which was mentioned earlier and I recommend to read it.<br />
Conceptually, let's have 2 forms which at the same time send requests to a server with a search query. Additionally let's measure a time which is needed to get responses back, because we all like numbers but not a row info, isn't it?</p>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#7f8989;">// src/ui.rs
</span><span style="color:#72ab00;">use </span><span>anyhow::Error;
</span><span style="color:#72ab00;">use </span><span>http::{Request, Response};
</span><span style="color:#72ab00;">use </span><span>serde_json::json;
</span><span style="color:#72ab00;">use </span><span>wasm_bindgen::prelude::</span><span style="color:#72ab00;">*</span><span>;
</span><span style="color:#72ab00;">use </span><span>yew::format::Json;
</span><span style="color:#72ab00;">use </span><span>yew::prelude::</span><span style="color:#72ab00;">*</span><span>;
</span><span style="color:#72ab00;">use </span><span>yew::services::{fetch::FetchTask, ConsoleService, FetchService};
</span><span>
</span><span style="color:#668f14;">pub struct </span><span style="color:#c23f31;">Model </span><span>{
</span><span>    </span><span style="color:#5597d6;">link</span><span>: ComponentLink&lt;</span><span style="color:#668f14;">Self</span><span>&gt;,
</span><span>
</span><span>    </span><span style="color:#5597d6;">search_value</span><span>: String,
</span><span>
</span><span>    </span><span style="color:#7f8989;">// this values are used for requests time measurements
</span><span>    </span><span style="color:#5597d6;">requests_start_time</span><span>: </span><span style="color:#668f14;">f64</span><span>,
</span><span>    </span><span style="color:#5597d6;">request_time_slow_diff_secs</span><span>: </span><span style="color:#668f14;">f64</span><span>,
</span><span>    </span><span style="color:#5597d6;">request_time_fast_diff_secs</span><span>: </span><span style="color:#668f14;">f64</span><span>,
</span><span>
</span><span>    </span><span style="color:#7f8989;">// found items to render
</span><span>    </span><span style="color:#5597d6;">found_items_slow</span><span>: </span><span style="color:#a2a001;">Vec</span><span>&lt;</span><span style="color:#a2a001;">String</span><span>&gt;,
</span><span>    </span><span style="color:#5597d6;">found_items_fast</span><span>: </span><span style="color:#a2a001;">Vec</span><span>&lt;</span><span style="color:#a2a001;">String</span><span>&gt;,
</span><span>	
</span><span>    </span><span style="color:#7f8989;">// in order to not drop and as a consequence abort our requests
</span><span>    </span><span style="color:#7f8989;">// we store them
</span><span>    </span><span style="color:#5597d6;">requests</span><span>: </span><span style="color:#a2a001;">Option</span><span>&lt;</span><span style="color:#a2a001;">Vec</span><span>&lt;FetchTask&gt;&gt;,
</span><span>}
</span><span>
</span><span style="color:#668f14;">pub enum </span><span style="color:#c23f31;">Msg </span><span>{
</span><span>    Lookup(</span><span style="color:#a2a001;">String</span><span>),
</span><span>    FoundSlow(</span><span style="color:#a2a001;">Vec</span><span>&lt;</span><span style="color:#a2a001;">String</span><span>&gt;),
</span><span>    FoundFast(</span><span style="color:#a2a001;">Vec</span><span>&lt;</span><span style="color:#a2a001;">String</span><span>&gt;),
</span><span>}
</span><span>
</span><span style="color:#668f14;">impl </span><span>Component </span><span style="color:#72ab00;">for </span><span style="color:#c23f31;">Model </span><span>{
</span><span>    </span><span style="color:#668f14;">type </span><span style="color:#c23f31;">Message </span><span style="color:#72ab00;">=</span><span> Msg;
</span><span>    </span><span style="color:#668f14;">type </span><span style="color:#c23f31;">Properties </span><span style="color:#72ab00;">= </span><span>();
</span><span>
</span><span>    </span><span style="color:#668f14;">fn </span><span style="color:#c23f31;">create</span><span>(</span><span style="color:#72ab00;">_</span><span>: </span><span style="color:#668f14;">Self::</span><span>Properties, </span><span style="color:#5597d6;">link</span><span>: ComponentLink&lt;</span><span style="color:#668f14;">Self</span><span>&gt;) -&gt; </span><span style="color:#668f14;">Self </span><span>{
</span><span>        </span><span style="color:#668f14;">Self </span><span>{
</span><span>            link,
</span><span>            search_value: </span><span style="color:#d07711;">&quot;&quot;</span><span>.</span><span style="color:#b39f04;">to_owned</span><span>(),
</span><span>            requests: </span><span style="color:#a2a001;">None</span><span>,
</span><span>            requests_start_time: instant::now(),
</span><span>            request_time_slow_diff_secs: </span><span style="color:#b3933a;">0.0</span><span>,
</span><span>            request_time_fast_diff_secs: </span><span style="color:#b3933a;">0.0</span><span>,
</span><span>
</span><span>            found_items_slow: </span><span style="color:#a2a001;">vec!</span><span>[],
</span><span>            found_items_fast: </span><span style="color:#a2a001;">vec!</span><span>[],
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#668f14;">fn </span><span style="color:#c23f31;">update</span><span>(</span><span style="color:#72ab00;">&amp;</span><span style="color:#668f14;">mut </span><span style="color:#5597d6;">self</span><span>, </span><span style="color:#5597d6;">msg</span><span>: </span><span style="color:#668f14;">Self::</span><span>Message) -&gt; ShouldRender {
</span><span>        </span><span style="color:#72ab00;">match</span><span> msg {
</span><span>            Msg::Lookup(v) </span><span style="color:#72ab00;">=&gt; </span><span>{
</span><span>                </span><span style="color:#5597d6;">self</span><span>.search_value </span><span style="color:#72ab00;">=</span><span> v.</span><span style="color:#b39f04;">clone</span><span>();
</span><span>                </span><span style="color:#668f14;">let</span><span> body </span><span style="color:#72ab00;">= &amp;</span><span style="color:#a2a001;">json!</span><span>({ </span><span style="color:#d07711;">&quot;text&quot;</span><span>: v });
</span><span>                </span><span style="color:#668f14;">let</span><span> request_slow </span><span style="color:#72ab00;">= </span><span>Request::post(</span><span style="color:#d07711;">&quot;/goods/lookup_slow&quot;</span><span>)
</span><span>                    .</span><span style="color:#b39f04;">body</span><span>(Json(body))
</span><span>                    .</span><span style="color:#b39f04;">expect</span><span>(</span><span style="color:#d07711;">&quot;slow request was sent&quot;</span><span>);
</span><span>                </span><span style="color:#668f14;">let</span><span> request_fast </span><span style="color:#72ab00;">= </span><span>Request::post(</span><span style="color:#d07711;">&quot;/goods/lookup_fast&quot;</span><span>)
</span><span>                    .</span><span style="color:#b39f04;">body</span><span>(Json(body))
</span><span>                    .</span><span style="color:#b39f04;">expect</span><span>(</span><span style="color:#d07711;">&quot;fast request was sent&quot;</span><span>);
</span><span>
</span><span>                </span><span style="color:#668f14;">let</span><span> slow_request </span><span style="color:#72ab00;">= </span><span>FetchService::fetch(
</span><span>                    request_slow,
</span><span>                    </span><span style="color:#5597d6;">self</span><span>.link
</span><span>                        .</span><span style="color:#b39f04;">callback</span><span>(|</span><span style="color:#5597d6;">response</span><span>: Response&lt;</span><span style="color:#a2a001;">Result</span><span>&lt;</span><span style="color:#a2a001;">String</span><span>, Error&gt;&gt;| {
</span><span>                            ConsoleService::log(</span><span style="color:#72ab00;">&amp;</span><span style="color:#a2a001;">format!</span><span>(</span><span style="color:#d07711;">&quot;</span><span style="color:#aeb52b;">{:?}</span><span style="color:#d07711;">&quot;</span><span>, response));
</span><span>                            Msg::FoundSlow(
</span><span>                                serde_json::from_slice(
</span><span>                                    </span><span style="color:#72ab00;">&amp;</span><span>response.</span><span style="color:#b39f04;">body</span><span>().</span><span style="color:#b39f04;">as_ref</span><span>().</span><span style="color:#b39f04;">unwrap</span><span>().</span><span style="color:#b39f04;">as_bytes</span><span>(),
</span><span>                                )
</span><span>                                .</span><span style="color:#b39f04;">unwrap</span><span>(),
</span><span>                            )
</span><span>                        }),
</span><span>                )
</span><span>                .</span><span style="color:#b39f04;">expect</span><span>(</span><span style="color:#d07711;">&quot;slow fetch was not completed&quot;</span><span>);
</span><span>                </span><span style="color:#668f14;">let</span><span> fast_request </span><span style="color:#72ab00;">= </span><span>FetchService::fetch(
</span><span>                    request_fast,
</span><span>                    </span><span style="color:#5597d6;">self</span><span>.link
</span><span>                        .</span><span style="color:#b39f04;">callback</span><span>(|</span><span style="color:#5597d6;">response</span><span>: Response&lt;</span><span style="color:#a2a001;">Result</span><span>&lt;</span><span style="color:#a2a001;">String</span><span>, Error&gt;&gt;| {
</span><span>                            ConsoleService::log(</span><span style="color:#72ab00;">&amp;</span><span style="color:#a2a001;">format!</span><span>(</span><span style="color:#d07711;">&quot;</span><span style="color:#aeb52b;">{:?}</span><span style="color:#d07711;">&quot;</span><span>, response.</span><span style="color:#b39f04;">body</span><span>()));
</span><span>                            </span><span style="color:#7f8989;">// Msg::FoundFast(
</span><span>                            </span><span style="color:#7f8989;">//     serde_json::from_slice(
</span><span>                            </span><span style="color:#7f8989;">//         &amp;response.body().as_ref().unwrap().as_bytes(),
</span><span>                            </span><span style="color:#7f8989;">//     )
</span><span>                            </span><span style="color:#7f8989;">//     .unwrap(),
</span><span>                            </span><span style="color:#7f8989;">// )
</span><span>                            Msg::FoundFast(</span><span style="color:#a2a001;">vec!</span><span>[])
</span><span>                        }),
</span><span>                )
</span><span>                .</span><span style="color:#b39f04;">expect</span><span>(</span><span style="color:#d07711;">&quot;fast fetch was not completed&quot;</span><span>);
</span><span>                </span><span style="color:#5597d6;">self</span><span>.requests </span><span style="color:#72ab00;">= </span><span style="color:#a2a001;">Some</span><span>(</span><span style="color:#a2a001;">vec!</span><span>[slow_request, fast_request]);
</span><span>                </span><span style="color:#5597d6;">self</span><span>.requests_start_time </span><span style="color:#72ab00;">= </span><span>instant::now();
</span><span>            }
</span><span>
</span><span>            Msg::FoundSlow(items) </span><span style="color:#72ab00;">=&gt; </span><span>{
</span><span>                </span><span style="color:#5597d6;">self</span><span>.found_items_slow </span><span style="color:#72ab00;">=</span><span> items;
</span><span>                </span><span style="color:#5597d6;">self</span><span>.request_time_slow_diff_secs </span><span style="color:#72ab00;">=
</span><span>                    (instant::now() </span><span style="color:#72ab00;">- </span><span style="color:#5597d6;">self</span><span>.requests_start_time) </span><span style="color:#72ab00;">/ </span><span style="color:#b3933a;">1000.0</span><span>;
</span><span>            }
</span><span>            Msg::FoundFast(items) </span><span style="color:#72ab00;">=&gt; </span><span>{
</span><span>                </span><span style="color:#5597d6;">self</span><span>.found_items_slow </span><span style="color:#72ab00;">=</span><span> items;
</span><span>				</span><span style="color:#7f8989;">// useless for now
</span><span>                </span><span style="color:#7f8989;">// self.request_time_fast_diff_secs =
</span><span>                </span><span style="color:#7f8989;">//    (instant::now() - self.requests_start_time) / 1000.0;
</span><span>            }
</span><span>        }
</span><span>
</span><span>        </span><span style="color:#b3933a;">true
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#668f14;">fn </span><span style="color:#c23f31;">change</span><span>(</span><span style="color:#72ab00;">&amp;</span><span style="color:#668f14;">mut </span><span style="color:#5597d6;">self</span><span>, </span><span style="color:#72ab00;">_</span><span>: </span><span style="color:#668f14;">Self::</span><span>Properties) -&gt; ShouldRender {
</span><span>        </span><span style="color:#b3933a;">true
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#668f14;">fn </span><span style="color:#c23f31;">view</span><span>(</span><span style="color:#72ab00;">&amp;</span><span style="color:#5597d6;">self</span><span>) -&gt; Html {
</span><span>        </span><span style="color:#a2a001;">html! </span><span>{
</span><span>        </span><span style="color:#72ab00;">&lt;</span><span>div class</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">&quot;forms&quot;</span><span style="color:#72ab00;">&gt;
</span><span>        </span><span style="color:#72ab00;">&lt;</span><span>div class</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">&quot;slow&quot;</span><span style="color:#72ab00;">&gt;
</span><span>        {</span><span style="color:#5597d6;">self</span><span>.</span><span style="color:#b39f04;">get_slow_form</span><span>()}
</span><span>        </span><span style="color:#72ab00;">&lt;/</span><span>div</span><span style="color:#72ab00;">&gt;
</span><span>        </span><span style="color:#72ab00;">&lt;</span><span>div class</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">&quot;fast&quot;</span><span style="color:#72ab00;">&gt;
</span><span>        {</span><span style="color:#5597d6;">self</span><span>.</span><span style="color:#b39f04;">get_fast_form</span><span>()}
</span><span>        </span><span style="color:#72ab00;">&lt;/</span><span>div</span><span style="color:#72ab00;">&gt;
</span><span>        </span><span style="color:#72ab00;">&lt;/</span><span>div</span><span style="color:#72ab00;">&gt;
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span style="color:#668f14;">impl </span><span style="color:#c23f31;">Model </span><span>{
</span><span>    </span><span style="color:#668f14;">fn </span><span style="color:#c23f31;">get_slow_form</span><span>(</span><span style="color:#72ab00;">&amp;</span><span style="color:#5597d6;">self</span><span>) -&gt; Html {
</span><span>        </span><span style="color:#a2a001;">html! </span><span>{
</span><span>            </span><span style="color:#72ab00;">&lt;</span><span>div class</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">&quot;form&quot;</span><span style="color:#72ab00;">&gt;
</span><span>                 </span><span style="color:#72ab00;">&lt;</span><span>h2</span><span style="color:#72ab00;">&gt;</span><span>{</span><span style="color:#a2a001;">format!</span><span>(</span><span style="color:#d07711;">&quot;Request time: </span><span style="color:#aeb52b;">{:.3}</span><span style="color:#d07711;">s&quot;</span><span>, </span><span style="color:#5597d6;">self</span><span>.request_time_slow_diff_secs)}</span><span style="color:#72ab00;">&lt;/</span><span>h2</span><span style="color:#72ab00;">&gt;
</span><span>                 </span><span style="color:#72ab00;">&lt;</span><span>input
</span><span>                     class</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">&quot;new-todo&quot;
</span><span>                     placeholder</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">&quot;What are we are looking for?&quot;
</span><span>                     value</span><span style="color:#72ab00;">=&amp;</span><span style="color:#5597d6;">self</span><span>.search_value
</span><span>                     oninput</span><span style="color:#72ab00;">=</span><span style="color:#5597d6;">self</span><span>.link.</span><span style="color:#b39f04;">callback</span><span>(|</span><span style="color:#5597d6;">e</span><span>: InputData| Msg::Lookup(e.value))
</span><span>                 </span><span style="color:#72ab00;">/&gt;
</span><span>                 </span><span style="color:#72ab00;">&lt;</span><span>ul class</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">&quot;found-items&quot;</span><span style="color:#72ab00;">&gt;</span><span>{</span><span style="color:#72ab00;">for </span><span style="color:#5597d6;">self</span><span>.found_items_slow.</span><span style="color:#b39f04;">iter</span><span>().</span><span style="color:#b39f04;">map</span><span>(|</span><span style="color:#5597d6;">i</span><span>| </span><span style="color:#a2a001;">html! </span><span>{</span><span style="color:#72ab00;">&lt;</span><span>span</span><span style="color:#72ab00;">&gt;</span><span>{</span><span style="color:#a2a001;">format!</span><span>(</span><span style="color:#d07711;">&quot;</span><span style="color:#aeb52b;">{}</span><span style="color:#d07711;">&quot;</span><span>, i)}</span><span style="color:#72ab00;">&lt;/</span><span>span</span><span style="color:#72ab00;">&gt;</span><span>})}</span><span style="color:#72ab00;">&lt;/</span><span>ul</span><span style="color:#72ab00;">&gt;
</span><span>            </span><span style="color:#72ab00;">&lt;/</span><span>div</span><span style="color:#72ab00;">&gt;
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#668f14;">fn </span><span style="color:#c23f31;">get_fast_form</span><span>(</span><span style="color:#72ab00;">&amp;</span><span style="color:#5597d6;">self</span><span>) -&gt; Html {
</span><span>        </span><span style="color:#a2a001;">html! </span><span>{
</span><span>            </span><span style="color:#72ab00;">&lt;</span><span>div class</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">&quot;form&quot;</span><span style="color:#72ab00;">&gt;
</span><span>                 </span><span style="color:#72ab00;">&lt;</span><span>h2</span><span style="color:#72ab00;">&gt;</span><span>{</span><span style="color:#a2a001;">format!</span><span>(</span><span style="color:#d07711;">&quot;Request time: </span><span style="color:#aeb52b;">{:.3}</span><span style="color:#d07711;">s&quot;</span><span>, </span><span style="color:#5597d6;">self</span><span>.request_time_fast_diff_secs )}</span><span style="color:#72ab00;">&lt;/</span><span>h2</span><span style="color:#72ab00;">&gt;
</span><span>                 </span><span style="color:#72ab00;">&lt;</span><span>input
</span><span>                     class</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">&quot;new-todo&quot;
</span><span>                     placeholder</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">&quot;What are we are looking for?&quot;
</span><span>                     value</span><span style="color:#72ab00;">=&amp;</span><span style="color:#5597d6;">self</span><span>.search_value
</span><span>                     oninput</span><span style="color:#72ab00;">=</span><span style="color:#5597d6;">self</span><span>.link.</span><span style="color:#b39f04;">callback</span><span>(|</span><span style="color:#5597d6;">e</span><span>: InputData| Msg::Lookup(e.value))
</span><span>                 </span><span style="color:#72ab00;">/&gt;
</span><span>                 </span><span style="color:#72ab00;">&lt;</span><span>ul class</span><span style="color:#72ab00;">=</span><span style="color:#d07711;">&quot;found-items&quot;</span><span style="color:#72ab00;">&gt;</span><span>{</span><span style="color:#72ab00;">for </span><span style="color:#5597d6;">self</span><span>.found_items_fast.</span><span style="color:#b39f04;">iter</span><span>().</span><span style="color:#b39f04;">map</span><span>(|</span><span style="color:#5597d6;">i</span><span>| </span><span style="color:#a2a001;">html! </span><span>{</span><span style="color:#72ab00;">&lt;</span><span>span</span><span style="color:#72ab00;">&gt;</span><span>{</span><span style="color:#a2a001;">format!</span><span>(</span><span style="color:#d07711;">&quot;</span><span style="color:#aeb52b;">{}</span><span style="color:#d07711;">&quot;</span><span>, i)}</span><span style="color:#72ab00;">&lt;/</span><span>span</span><span style="color:#72ab00;">&gt;</span><span>})}</span><span style="color:#72ab00;">&lt;/</span><span>ul</span><span style="color:#72ab00;">&gt;
</span><span>            </span><span style="color:#72ab00;">&lt;/</span><span>div</span><span style="color:#72ab00;">&gt;
</span><span>        }
</span><span>    }
</span><span>}
</span><span>
</span><span>#[</span><span style="color:#5597d6;">wasm_bindgen</span><span>(start)]
</span><span style="color:#668f14;">pub fn </span><span style="color:#c23f31;">run_app</span><span>() {
</span><span>    App::&lt;Model&gt;::new().</span><span style="color:#b39f04;">mount_to_body</span><span>();
</span><span>}
</span></code></pre>
<h1 id="server">Server<a class="zola-anchor" href="#server" aria-label="Anchor link for: server">ðŸ”—</a></h1>
<p>In order to search goods by descriptions we need descriptions.<br />
I found <a href="https://www.kaggle.com/sachsene/amazons-advertisements/data">this one</a>.
Download and place it in project's root(if you want).<br />
Descriptions are stored in <a href="https://en.wikipedia.org/wiki/Comma-separated_values">csv</a>, so firstly we need to parse them:</p>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#7f8989;">// src/lib.rs
</span><span>
</span><span style="color:#7f8989;">// --//--
</span><span style="color:#668f14;">mod </span><span style="color:#c23f31;">parse_csv</span><span>;
</span></code></pre>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#72ab00;">use </span><span>std::error::Error;
</span><span>
</span><span style="color:#668f14;">pub fn </span><span style="color:#c23f31;">parse_csv</span><span>() -&gt; </span><span style="color:#a2a001;">Result</span><span>&lt;</span><span style="color:#a2a001;">Vec</span><span>&lt;(</span><span style="color:#668f14;">usize</span><span>, String)&gt;, </span><span style="color:#a2a001;">Box</span><span>&lt;dyn Error&gt;&gt; {
</span><span>    </span><span style="color:#668f14;">let</span><span> wiki </span><span style="color:#72ab00;">= </span><span>std::io::BufReader::new(
</span><span>        std::fs::File::open(</span><span style="color:#d07711;">&quot;./amazon_combined_scrapped_data.csv&quot;</span><span>).</span><span style="color:#b39f04;">unwrap</span><span>(),
</span><span>    );
</span><span>    </span><span style="color:#668f14;">let mut</span><span> descriptions </span><span style="color:#72ab00;">= </span><span style="color:#a2a001;">vec!</span><span>[];
</span><span>
</span><span>    </span><span style="color:#668f14;">let mut</span><span> rdr </span><span style="color:#72ab00;">= </span><span>csv::Reader::from_reader(wiki);
</span><span>    </span><span style="color:#72ab00;">for </span><span>(i, result) </span><span style="color:#72ab00;">in</span><span> rdr.</span><span style="color:#b39f04;">records</span><span>().</span><span style="color:#b39f04;">enumerate</span><span>() {
</span><span>        </span><span style="color:#668f14;">let</span><span> record </span><span style="color:#72ab00;">=</span><span> result</span><span style="color:#72ab00;">?</span><span>;
</span><span>        </span><span style="color:#72ab00;">for</span><span> f </span><span style="color:#72ab00;">in</span><span> record.</span><span style="color:#b39f04;">iter</span><span>() {
</span><span>            descriptions.</span><span style="color:#b39f04;">push</span><span>((i, f.</span><span style="color:#b39f04;">to_string</span><span>()));
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#a2a001;">Ok</span><span>(descriptions)
</span><span>}
</span></code></pre>
<p>So now with that function we can get a vector of goods descriptions.<br />
The last part is a server itself:</p>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#7f8989;">// src/lib.rs
</span><span>
</span><span style="color:#7f8989;">// --//--
</span><span style="color:#668f14;">mod </span><span style="color:#c23f31;">server</span><span>.rs
</span></code></pre>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#7f8989;">// src/server.rs
</span><span>
</span><span style="color:#72ab00;">use </span><span>rocket::{post, routes, State};
</span><span style="color:#7f8989;">// get and send JSON&#39;s
</span><span style="color:#72ab00;">use </span><span>rocket_contrib::json;
</span><span style="color:#72ab00;">use </span><span>rocket_contrib::json::Json;
</span><span style="color:#72ab00;">use </span><span>rocket_contrib::json::JsonValue;
</span><span style="color:#7f8989;">// serves our static assets for UI
</span><span style="color:#72ab00;">use </span><span>rocket_contrib::serve::StaticFiles;
</span><span style="color:#7f8989;">// deserializes JSON bodies from UI
</span><span style="color:#72ab00;">use </span><span>serde::Deserialize;
</span><span>
</span><span style="color:#72ab00;">use crate</span><span>::parse_csv;
</span><span>
</span><span style="color:#7f8989;">// server&#39;s shared state
</span><span style="color:#7f8989;">// basically it&#39;s descriptions vector of goods which we sell =)
</span><span style="color:#668f14;">struct </span><span style="color:#c23f31;">Store </span><span>{
</span><span>    </span><span style="color:#5597d6;">goods</span><span>: </span><span style="color:#a2a001;">Vec</span><span>&lt;</span><span style="color:#a2a001;">String</span><span>&gt;,
</span><span>}
</span><span>
</span><span style="color:#7f8989;">// this funciton is used for our server bootstraping
</span><span style="color:#668f14;">pub fn </span><span style="color:#c23f31;">run_server</span><span>() {
</span><span>    </span><span style="color:#7f8989;">// parsed goods descritpions
</span><span>    </span><span style="color:#668f14;">let</span><span> items </span><span style="color:#72ab00;">= </span><span>parse_csv::parse_csv().</span><span style="color:#b39f04;">unwrap</span><span>();
</span><span>
</span><span>    rocket::ignite()
</span><span>        .</span><span style="color:#b39f04;">manage</span><span>(Store { goods: items })
</span><span>        </span><span style="color:#7f8989;">// serves static files which are placed in myox_ftse/static/
</span><span>        .</span><span style="color:#b39f04;">mount</span><span>(</span><span style="color:#d07711;">&quot;/&quot;</span><span>, StaticFiles::from(</span><span style="color:#d07711;">&quot;./static&quot;</span><span>))
</span><span>        </span><span style="color:#7f8989;">// there will be two routes:
</span><span>        </span><span style="color:#7f8989;">// the first for slow requests serving
</span><span>        </span><span style="color:#7f8989;">// the second one for fast requests serving
</span><span>        </span><span style="color:#7f8989;">// currently only slow requests serving is implemented
</span><span>        </span><span style="color:#7f8989;">// fast part will be implemented incrementally
</span><span>        .</span><span style="color:#b39f04;">mount</span><span>(</span><span style="color:#d07711;">&quot;/goods&quot;</span><span>, </span><span style="color:#a2a001;">routes!</span><span>[lookup_slow, lookup_fast])
</span><span>        .</span><span style="color:#b39f04;">launch</span><span>();
</span><span>}
</span><span>
</span><span>#[</span><span style="color:#5597d6;">rocket</span><span>::</span><span style="color:#5597d6;">post</span><span>(</span><span style="color:#d07711;">&quot;/lookup_slow&quot;</span><span>, data </span><span style="color:#72ab00;">= </span><span style="color:#d07711;">&quot;&lt;search_text&gt;&quot;</span><span>)]
</span><span style="color:#668f14;">fn </span><span style="color:#c23f31;">lookup_slow</span><span>(</span><span style="color:#5597d6;">state</span><span>: State&lt;Store&gt;, </span><span style="color:#5597d6;">search_text</span><span>: Json&lt;Search&gt;) -&gt; JsonValue {
</span><span>    </span><span style="color:#668f14;">let</span><span> obj </span><span style="color:#72ab00;">=</span><span> search_text.</span><span style="color:#b39f04;">into_inner</span><span>();
</span><span>    </span><span style="color:#668f14;">let</span><span> re </span><span style="color:#72ab00;">= </span><span>regex::Regex::new(</span><span style="color:#72ab00;">&amp;</span><span style="color:#a2a001;">format!</span><span>(</span><span style="color:#d07711;">&quot;</span><span style="color:#aeb52b;">\\</span><span style="color:#d07711;">b</span><span style="color:#aeb52b;">{}\\</span><span style="color:#d07711;">b&quot;</span><span>, obj.text)).</span><span style="color:#b39f04;">unwrap</span><span>();
</span><span>
</span><span>    </span><span style="color:#668f14;">let</span><span> found: </span><span style="color:#a2a001;">Vec</span><span>&lt;</span><span style="color:#a2a001;">String</span><span>&gt; </span><span style="color:#72ab00;">=</span><span> state
</span><span>        .</span><span style="color:#b39f04;">inner</span><span>()
</span><span>        .goods
</span><span>        .</span><span style="color:#b39f04;">iter</span><span>()
</span><span>        .</span><span style="color:#b39f04;">filter</span><span>(|</span><span style="color:#5597d6;">item</span><span>| item.</span><span style="color:#b39f04;">find</span><span>(obj.text.</span><span style="color:#b39f04;">as_str</span><span>()).</span><span style="color:#b39f04;">is_some</span><span>())
</span><span>        .</span><span style="color:#b39f04;">map</span><span>(|</span><span style="color:#5597d6;">v</span><span>| v.</span><span style="color:#b39f04;">to_string</span><span>())
</span><span>        .</span><span style="color:#b39f04;">collect</span><span>();
</span><span>
</span><span>    </span><span style="color:#a2a001;">json!</span><span>(found)
</span><span>}
</span><span>
</span><span>#[</span><span style="color:#5597d6;">rocket</span><span>::</span><span style="color:#5597d6;">post</span><span>(</span><span style="color:#d07711;">&quot;/lookup_fast&quot;</span><span>, data </span><span style="color:#72ab00;">= </span><span style="color:#d07711;">&quot;&lt;search_text&gt;&quot;</span><span>)]
</span><span style="color:#668f14;">fn </span><span style="color:#c23f31;">lookup_fast</span><span>(</span><span style="color:#5597d6;">state</span><span>: State&lt;Store&gt;, </span><span style="color:#5597d6;">search_text</span><span>: Json&lt;Search&gt;) -&gt; JsonValue {
</span><span>    </span><span style="color:#668f14;">let</span><span> v: </span><span style="color:#a2a001;">Vec</span><span>&lt;</span><span style="color:#a2a001;">String</span><span>&gt; </span><span style="color:#72ab00;">= </span><span style="color:#a2a001;">vec!</span><span>[];
</span><span>
</span><span>    </span><span style="color:#a2a001;">json!</span><span>(v)
</span><span>}
</span></code></pre>
<p>Finnaly let's bootstrap it!</p>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#7f8989;">// src/bin.rs
</span><span>
</span><span style="color:#668f14;">fn </span><span style="color:#c23f31;">main</span><span>() {
</span><span>    myox_ftse_lib::server::run_server();
</span><span>}
</span></code></pre>
<p>Now open a terminal and in project's root type:</p>
<pre data-lang="bash" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#5597d6;">//</span><span> for ui rebuildings
</span><span style="color:#5597d6;">$</span><span> cargo make build
</span></code></pre>
<p>Open the second terminal and type there: </p>
<pre data-lang="bash" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#5597d6;">//</span><span> start a server
</span><span style="color:#5597d6;">$</span><span> cargo run
</span></code></pre>
<p><img src="../myox_ftse_slow_request_good.png" alt="slow requests results good" /></p>
<p>Not so bad.<br />
After some time customer comes back and says that it's inconvenient to scroll through things which are useless.<br />
Take a look: we searched <strong>rust</strong> but there are results which are just substrings but not a word what we are looking for: 
<img src="../myox_ftse_slow_request_bad.png" alt="slow request results bad" /></p>
<p>Ok, how we can fix it? Probably rexeges can help us. Let's give it a try!</p>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#7f8989;">// src/server.rs
</span><span>
</span><span>#[</span><span style="color:#5597d6;">rocket</span><span>::</span><span style="color:#5597d6;">post</span><span>(</span><span style="color:#d07711;">&quot;/lookup_slow&quot;</span><span>, data </span><span style="color:#72ab00;">= </span><span style="color:#d07711;">&quot;&lt;search_text&gt;&quot;</span><span>)]
</span><span style="color:#668f14;">fn </span><span style="color:#c23f31;">lookup_slow</span><span>(</span><span style="color:#5597d6;">state</span><span>: State&lt;Store&gt;, </span><span style="color:#5597d6;">search_text</span><span>: Json&lt;Search&gt;) -&gt; JsonValue {
</span><span>    </span><span style="color:#668f14;">let</span><span> obj </span><span style="color:#72ab00;">=</span><span> search_text.</span><span style="color:#b39f04;">into_inner</span><span>();
</span><span style="color:#72ab00;">+   </span><span style="color:#668f14;">let</span><span> re </span><span style="color:#72ab00;">= </span><span>regex::Regex::new(</span><span style="color:#72ab00;">&amp;</span><span style="color:#a2a001;">format!</span><span>(</span><span style="color:#d07711;">&quot;</span><span style="color:#aeb52b;">\\</span><span style="color:#d07711;">b</span><span style="color:#aeb52b;">{}\\</span><span style="color:#d07711;">b&quot;</span><span>, obj.text)).</span><span style="color:#b39f04;">unwrap</span><span>();
</span><span>
</span><span>    </span><span style="color:#668f14;">let</span><span> found: </span><span style="color:#a2a001;">Vec</span><span>&lt;</span><span style="color:#a2a001;">String</span><span>&gt; </span><span style="color:#72ab00;">=</span><span> state
</span><span>        .</span><span style="color:#b39f04;">inner</span><span>()
</span><span>        .goods
</span><span>        .</span><span style="color:#b39f04;">iter</span><span>()
</span><span style="color:#72ab00;">-       </span><span>.</span><span style="color:#b39f04;">filter</span><span>(|</span><span style="color:#5597d6;">item</span><span>| item.</span><span style="color:#b39f04;">find</span><span>(obj.text.</span><span style="color:#b39f04;">as_str</span><span>()).</span><span style="color:#b39f04;">is_some</span><span>())
</span><span style="color:#72ab00;">+       </span><span>.</span><span style="color:#b39f04;">filter</span><span>(|</span><span style="color:#5597d6;">item</span><span>| re.</span><span style="color:#b39f04;">is_match</span><span>(item.</span><span style="color:#b39f04;">as_str</span><span>()))
</span><span>        .</span><span style="color:#b39f04;">map</span><span>(|</span><span style="color:#5597d6;">v</span><span>| v.</span><span style="color:#b39f04;">to_string</span><span>())
</span><span>        .</span><span style="color:#b39f04;">collect</span><span>();
</span><span>
</span><span>    </span><span style="color:#a2a001;">json!</span><span>(found)
</span><span>}
</span></code></pre>
<p>Let's take a look:</p>
<p><img src="../myox_ftse_slow_request_ugly.png" alt="slow request results ugly" /></p>
<p>The good news - the problem solved. The bad news - the customer won't wait so much time.<br />
Can we do better? Yes, we can!</p>
<h1 id="inverted-index-full-text-search-engines-etc">Inverted Index, Full Text Search Engines, etc<a class="zola-anchor" href="#inverted-index-full-text-search-engines-etc" aria-label="Anchor link for: inverted-index-full-text-search-engines-etc">ðŸ”—</a></h1>
<p>The key idea is find a suitable data structure which will be used for searching. You've probably seen in readed books a page which shows a word and pages which contain this word. And that's it.<br />
In a more detail: there are o lot of texts. We want to search against them. Let's read all documents and save a word with corresponded document id. When searching - make a lookup against all words, find corresponded documents and retrieve them.</p>
<p><img src="../inverted_index.png" alt="inverted index" /></p>
<p>An attentive reader will notice that not all words after texts processing stored in the table. Futhermore they have a different form.<br />
Indeed there are words which are often used and kind of useless: <strong>and, or, the</strong>, etc.<br />
Punctuation marks are also not super usefull.<br />
Let's consider <strong>Rust</strong> and <strong>rust</strong> words: they have the same semantics(in the sense of the word meaning) but they are not equal -&gt; let's make them lowercased.<br />
Let's consider <strong>cars</strong> and <strong>car</strong>: these both are also about the same, but one plural, the other one not. Let's also get rid of such cases and store only one word in its initial form.</p>
<p>This all happens in this green block. Let's unwrap it.</p>
<p><img src="../myox_ftse_slow_linguistic_modules.png" alt="linguistic modules" /></p>
<p><strong>Tokenizer</strong> gets input and splits it into lexemes. <strong>Linguistic modules</strong> preprocess them before they trap into <strong>indexer</strong> which stores them.</p>
<p>I hope that now you understand a key idea. Let's code it.</p>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#7f8989;">// src/lib.rs
</span><span>
</span><span style="color:#7f8989;">// --//--
</span><span style="color:#668f14;">mod </span><span style="color:#c23f31;">tokenizer</span><span>;
</span><span style="color:#668f14;">mod </span><span style="color:#c23f31;">lingua</span><span>;
</span></code></pre>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#7f8989;">// src/tokenizer.rs
</span><span>
</span><span style="color:#668f14;">pub fn </span><span style="color:#c23f31;">tokenize</span><span>(</span><span style="color:#5597d6;">s</span><span>: </span><span style="color:#72ab00;">&amp;</span><span style="color:#668f14;">str</span><span>) -&gt; </span><span style="color:#a2a001;">Vec</span><span>&lt;</span><span style="color:#a2a001;">String</span><span>&gt; {
</span><span>    s.split::&lt;</span><span style="color:#668f14;">fn</span><span>(</span><span style="color:#668f14;">char</span><span>) -&gt; </span><span style="color:#668f14;">bool</span><span>&gt;(|</span><span style="color:#5597d6;">l</span><span>| </span><span style="color:#72ab00;">!</span><span>l.</span><span style="color:#b39f04;">is_alphabetic</span><span>())
</span><span>        .</span><span style="color:#b39f04;">map</span><span>(|</span><span style="color:#5597d6;">v</span><span>| v.</span><span style="color:#b39f04;">to_string</span><span>())
</span><span>        .</span><span style="color:#b39f04;">collect</span><span>()
</span><span>}
</span></code></pre>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#7f8989;">// src/lingua.rs
</span><span>
</span><span style="color:#7f8989;">// this function is basically a pipeline of linguistic modules
</span><span style="color:#668f14;">pub fn </span><span style="color:#c23f31;">preprocess</span><span>(</span><span style="color:#5597d6;">tokens</span><span>: </span><span style="color:#a2a001;">Vec</span><span>&lt;(</span><span style="color:#668f14;">usize</span><span>, String)&gt;) -&gt; </span><span style="color:#a2a001;">Vec</span><span>&lt;(</span><span style="color:#668f14;">usize</span><span>, String)&gt; {
</span><span>    </span><span style="color:#a2a001;">todo!</span><span>()
</span><span>}
</span><span>
</span><span style="color:#668f14;">fn </span><span style="color:#c23f31;">to_lower_case</span><span>(</span><span style="color:#5597d6;">tokens</span><span>: </span><span style="color:#a2a001;">Vec</span><span>&lt;(</span><span style="color:#668f14;">usize</span><span>, </span><span style="color:#a2a001;">Vec</span><span>&lt;</span><span style="color:#a2a001;">String</span><span>&gt;)&gt;) -&gt; </span><span style="color:#a2a001;">Vec</span><span>&lt;(</span><span style="color:#668f14;">usize</span><span>, </span><span style="color:#a2a001;">Vec</span><span>&lt;</span><span style="color:#a2a001;">String</span><span>&gt;)&gt; {
</span><span>    tokens
</span><span>        .</span><span style="color:#b39f04;">iter</span><span>()
</span><span>        .</span><span style="color:#b39f04;">map</span><span>(|(</span><span style="color:#5597d6;">i</span><span>, </span><span style="color:#5597d6;">ts</span><span>)| (</span><span style="color:#72ab00;">*</span><span>i, ts.</span><span style="color:#b39f04;">iter</span><span>().</span><span style="color:#b39f04;">map</span><span>(|</span><span style="color:#5597d6;">s</span><span>| s.</span><span style="color:#b39f04;">to_lowercase</span><span>()).</span><span style="color:#b39f04;">collect</span><span>()))
</span><span>        .</span><span style="color:#b39f04;">collect</span><span>()
</span><span>}
</span></code></pre>
<p>Next we need to remove all &quot;useless&quot;(stopwords) words. There are different sources which make analysis and can provide such info.<br />
We will use the crate called <strong>stopwords</strong> as well as <strong>lazy_static</strong> for storing these words:</p>
<pre data-lang="bash" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#5597d6;">cargo</span><span> add stopwords
</span><span style="color:#5597d6;">cargo</span><span> add lazy_static
</span><span>
</span></code></pre>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#7f8989;">// src/lingua.rs
</span><span>
</span><span style="color:#7f8989;">// --//--
</span><span>
</span><span>lazy_static::lazy_static</span><span style="color:#72ab00;">! </span><span>{
</span><span>    </span><span style="color:#668f14;">static ref </span><span style="color:#b3933a;">STOPWORDS</span><span>: HashSet&lt;</span><span style="color:#72ab00;">&amp;</span><span style="color:#668f14;">&#39;static str</span><span>&gt; </span><span style="color:#72ab00;">= </span><span>Spark::stopwords(Language::English)
</span><span>        .</span><span style="color:#b39f04;">unwrap</span><span>()
</span><span>        .</span><span style="color:#b39f04;">iter</span><span>()
</span><span>        .</span><span style="color:#b39f04;">map</span><span>(|</span><span style="color:#5597d6;">v</span><span>| </span><span style="color:#72ab00;">*</span><span>v)
</span><span>        .</span><span style="color:#b39f04;">collect</span><span>();
</span><span>}
</span><span>
</span><span style="color:#7f8989;">// --//--
</span><span>
</span><span style="color:#668f14;">fn </span><span style="color:#c23f31;">remove_stopwords</span><span>(</span><span style="color:#668f14;">mut </span><span style="color:#5597d6;">tokens</span><span>: </span><span style="color:#a2a001;">Vec</span><span>&lt;(</span><span style="color:#668f14;">usize</span><span>, </span><span style="color:#a2a001;">Vec</span><span>&lt;</span><span style="color:#a2a001;">String</span><span>&gt;)&gt;) -&gt; </span><span style="color:#a2a001;">Vec</span><span>&lt;(</span><span style="color:#668f14;">usize</span><span>, </span><span style="color:#a2a001;">Vec</span><span>&lt;</span><span style="color:#a2a001;">String</span><span>&gt;)&gt; {
</span><span>    tokens
</span><span>        .</span><span style="color:#b39f04;">iter_mut</span><span>()
</span><span>        .</span><span style="color:#b39f04;">for_each</span><span>(|(_, </span><span style="color:#5597d6;">ts</span><span>)| ts.</span><span style="color:#b39f04;">retain</span><span>(|</span><span style="color:#5597d6;">s</span><span>| </span><span style="color:#72ab00;">!</span><span style="color:#b3933a;">STOPWORDS</span><span>.</span><span style="color:#b39f04;">contains</span><span>(</span><span style="color:#72ab00;">&amp;</span><span>s.</span><span style="color:#b39f04;">as_str</span><span>())));
</span><span>
</span><span>    tokens
</span><span>}
</span></code></pre>
<p>Next let's normalize words. This process is called <strong>stemming</strong>:</p>
<pre data-lang="bash" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#5597d6;">$</span><span> cargo add rust-stemmers
</span></code></pre>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#7f8989;">// src/lingua.rs
</span><span>
</span><span style="color:#7f8989;">// --//--
</span><span>
</span><span style="color:#72ab00;">use </span><span>rust_stemmers::{Algorithm, Stemmer};
</span><span>
</span><span style="color:#7f8989;">// --//--
</span><span>
</span><span style="color:#668f14;">fn </span><span style="color:#c23f31;">normalize</span><span>(</span><span style="color:#5597d6;">tokens</span><span>: </span><span style="color:#a2a001;">Vec</span><span>&lt;(</span><span style="color:#668f14;">usize</span><span>, </span><span style="color:#a2a001;">Vec</span><span>&lt;</span><span style="color:#a2a001;">String</span><span>&gt;)&gt;) -&gt; </span><span style="color:#a2a001;">Vec</span><span>&lt;(</span><span style="color:#668f14;">usize</span><span>, </span><span style="color:#a2a001;">Vec</span><span>&lt;</span><span style="color:#a2a001;">String</span><span>&gt;)&gt; {
</span><span>    </span><span style="color:#668f14;">let</span><span> en_stemmer </span><span style="color:#72ab00;">= </span><span>Stemmer::create(Algorithm::English);
</span><span>
</span><span>    tokens
</span><span>        .</span><span style="color:#b39f04;">iter</span><span>()
</span><span>        .</span><span style="color:#b39f04;">map</span><span>(|(</span><span style="color:#5597d6;">i</span><span>, </span><span style="color:#5597d6;">ts</span><span>)| {
</span><span>            (
</span><span>                </span><span style="color:#72ab00;">*</span><span>i,
</span><span>                ts.</span><span style="color:#b39f04;">iter</span><span>()
</span><span>                    .</span><span style="color:#b39f04;">map</span><span>(|</span><span style="color:#5597d6;">s</span><span>| en_stemmer.</span><span style="color:#b39f04;">stem</span><span>(</span><span style="color:#72ab00;">&amp;</span><span>s.</span><span style="color:#b39f04;">as_str</span><span>()).</span><span style="color:#b39f04;">to_string</span><span>())
</span><span>                    .</span><span style="color:#b39f04;">collect</span><span>(),
</span><span>            )
</span><span>        })
</span><span>        .</span><span style="color:#b39f04;">collect</span><span>()
</span><span>}
</span></code></pre>
<p>Finnally, let's compose this processors:</p>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#668f14;">pub fn </span><span style="color:#c23f31;">preprocess</span><span>(</span><span style="color:#5597d6;">tokens</span><span>: </span><span style="color:#a2a001;">Vec</span><span>&lt;(</span><span style="color:#668f14;">usize</span><span>, </span><span style="color:#a2a001;">Vec</span><span>&lt;</span><span style="color:#a2a001;">String</span><span>&gt;)&gt;) -&gt; </span><span style="color:#a2a001;">Vec</span><span>&lt;(</span><span style="color:#668f14;">usize</span><span>, </span><span style="color:#a2a001;">Vec</span><span>&lt;</span><span style="color:#a2a001;">String</span><span>&gt;)&gt; {
</span><span style="color:#72ab00;">-    </span><span style="color:#a2a001;">todo!</span><span>()
</span><span style="color:#72ab00;">+    </span><span>[to_lower_case, remove_stopwords, normalize]
</span><span style="color:#72ab00;">+        </span><span>.</span><span style="color:#b39f04;">iter</span><span>()
</span><span style="color:#72ab00;">+        </span><span>.</span><span style="color:#b39f04;">fold</span><span>(tokens, |</span><span style="color:#5597d6;">transformed</span><span>, </span><span style="color:#5597d6;">processor</span><span>| </span><span style="color:#b39f04;">processor</span><span>(transformed))
</span><span>}
</span></code></pre>
<p>Now we need to store processed values:</p>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#7f8989;">// src/lib.rs
</span><span>
</span><span style="color:#7f8989;">// --//--
</span><span>
</span><span style="color:#668f14;">mod </span><span style="color:#c23f31;">indexer</span><span>;
</span></code></pre>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#7f8989;">// src/indexer.rs
</span><span>
</span><span style="color:#72ab00;">use </span><span>std::collections::{HashMap, HashSet};
</span><span>
</span><span style="color:#668f14;">pub fn </span><span style="color:#c23f31;">index</span><span>(</span><span style="color:#5597d6;">vocabulary</span><span>: </span><span style="color:#a2a001;">Vec</span><span>&lt;(</span><span style="color:#668f14;">usize</span><span>, </span><span style="color:#a2a001;">Vec</span><span>&lt;</span><span style="color:#a2a001;">String</span><span>&gt;)&gt;) -&gt; HashMap&lt;</span><span style="color:#a2a001;">String</span><span>, HashSet&lt;</span><span style="color:#668f14;">usize</span><span>&gt;&gt; {
</span><span>    </span><span style="color:#668f14;">let mut</span><span> inv_index: HashMap&lt;</span><span style="color:#a2a001;">String</span><span>, HashSet&lt;</span><span style="color:#668f14;">usize</span><span>&gt;&gt; </span><span style="color:#72ab00;">= </span><span>HashMap::new();
</span><span>
</span><span>    vocabulary.</span><span style="color:#b39f04;">into_iter</span><span>().</span><span style="color:#b39f04;">for_each</span><span>(|(</span><span style="color:#5597d6;">i</span><span>, </span><span style="color:#5597d6;">ts</span><span>)| {
</span><span>        ts.</span><span style="color:#b39f04;">into_iter</span><span>().</span><span style="color:#b39f04;">for_each</span><span>(|</span><span style="color:#5597d6;">s</span><span>| {
</span><span>            inv_index.</span><span style="color:#b39f04;">entry</span><span>(s).</span><span style="color:#b39f04;">or_default</span><span>().</span><span style="color:#b39f04;">insert</span><span>(i);
</span><span>        });
</span><span>    });
</span><span>
</span><span>    inv_index
</span><span>}
</span></code></pre>
<p>We near the finish. Let's add a fast lookup variant to our API:</p>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#7f8989;">// src/server.rs
</span><span>
</span><span style="color:#668f14;">struct </span><span style="color:#c23f31;">Store </span><span>{
</span><span>    </span><span style="color:#5597d6;">goods</span><span>: </span><span style="color:#a2a001;">Vec</span><span>&lt;(</span><span style="color:#668f14;">usize</span><span>, String)&gt;,
</span><span>+   </span><span style="color:#5597d6;">indexed_goods</span><span>: std::collections::HashMap&lt;</span><span style="color:#a2a001;">String</span><span>, std::collections::HashSet&lt;</span><span style="color:#668f14;">usize</span><span>&gt;&gt;,
</span><span>}
</span><span>
</span><span style="color:#668f14;">pub fn </span><span style="color:#c23f31;">run_server</span><span>() {
</span><span>    </span><span style="color:#668f14;">let</span><span> now </span><span style="color:#72ab00;">= </span><span>std::time::Instant::now();
</span><span>    </span><span style="color:#668f14;">let</span><span> items </span><span style="color:#72ab00;">= </span><span>parse_csv::parse_csv().</span><span style="color:#b39f04;">unwrap</span><span>();
</span><span style="color:#72ab00;">+   </span><span style="color:#668f14;">let</span><span> indexed_goods </span><span style="color:#72ab00;">= crate</span><span>::indexer::index(</span><span style="color:#72ab00;">crate</span><span>::lingua::preprocess(
</span><span style="color:#72ab00;">+</span><span>       items
</span><span style="color:#72ab00;">+           </span><span>.</span><span style="color:#b39f04;">clone</span><span>()
</span><span style="color:#72ab00;">+           </span><span>.</span><span style="color:#b39f04;">iter</span><span>()
</span><span style="color:#72ab00;">+           </span><span>.</span><span style="color:#b39f04;">map</span><span>(|(</span><span style="color:#5597d6;">i</span><span>, </span><span style="color:#5597d6;">s</span><span>)| (</span><span style="color:#72ab00;">*</span><span>i, </span><span style="color:#72ab00;">crate</span><span>::tokenizer::tokenize(s.</span><span style="color:#b39f04;">as_str</span><span>())))
</span><span style="color:#72ab00;">+           </span><span>.</span><span style="color:#b39f04;">collect</span><span>(),
</span><span style="color:#72ab00;">+   </span><span>));
</span><span>
</span><span>    </span><span style="color:#a2a001;">println!</span><span>(</span><span style="color:#d07711;">&quot;Parsing time: </span><span style="color:#aeb52b;">{}</span><span style="color:#d07711;">&quot;</span><span>, now.</span><span style="color:#b39f04;">elapsed</span><span>().</span><span style="color:#b39f04;">as_secs</span><span>());
</span><span>    </span><span style="color:#a2a001;">println!</span><span>(</span><span style="color:#d07711;">&quot;Items count: </span><span style="color:#aeb52b;">{}</span><span style="color:#d07711;">&quot;</span><span>, items.</span><span style="color:#b39f04;">len</span><span>());
</span><span>
</span><span>    rocket::ignite()
</span><span>        .</span><span style="color:#b39f04;">manage</span><span>(Store {
</span><span>            goods: items,
</span><span style="color:#72ab00;">+</span><span>           indexed_goods,
</span><span>        })
</span><span>        .</span><span style="color:#b39f04;">mount</span><span>(</span><span style="color:#d07711;">&quot;/&quot;</span><span>, StaticFiles::from(</span><span style="color:#d07711;">&quot;./static&quot;</span><span>))
</span><span>        .</span><span style="color:#b39f04;">mount</span><span>(</span><span style="color:#d07711;">&quot;/goods&quot;</span><span>, </span><span style="color:#a2a001;">routes!</span><span>[lookup_slow, lookup_fast])
</span><span>        .</span><span style="color:#b39f04;">launch</span><span>();
</span><span>}
</span><span>
</span><span>#[</span><span style="color:#5597d6;">rocket</span><span>::</span><span style="color:#5597d6;">post</span><span>(</span><span style="color:#d07711;">&quot;/lookup_fast&quot;</span><span>, data </span><span style="color:#72ab00;">= </span><span style="color:#d07711;">&quot;&lt;search_text&gt;&quot;</span><span>)]
</span><span style="color:#668f14;">fn </span><span style="color:#c23f31;">lookup_fast</span><span>(</span><span style="color:#5597d6;">state</span><span>: State&lt;Store&gt;, </span><span style="color:#5597d6;">search_text</span><span>: Json&lt;Search&gt;) -&gt; JsonValue {
</span><span style="color:#72ab00;">-   </span><span style="color:#668f14;">let</span><span> v: </span><span style="color:#a2a001;">Vec</span><span>&lt;</span><span style="color:#a2a001;">String</span><span>&gt; </span><span style="color:#72ab00;">= </span><span style="color:#a2a001;">vec!</span><span>[];
</span><span style="color:#72ab00;">-
</span><span style="color:#72ab00;">-   </span><span style="color:#a2a001;">json!</span><span>(v)
</span><span style="color:#72ab00;">-
</span><span>    </span><span style="color:#668f14;">let</span><span> obj </span><span style="color:#72ab00;">=</span><span> search_text.</span><span style="color:#b39f04;">into_inner</span><span>();
</span><span>
</span><span>    </span><span style="color:#668f14;">let</span><span> goods: </span><span style="color:#72ab00;">&amp;</span><span style="color:#a2a001;">Vec</span><span>&lt;(</span><span style="color:#668f14;">usize</span><span>, String)&gt; </span><span style="color:#72ab00;">=</span><span> state.</span><span style="color:#b39f04;">inner</span><span>().goods.</span><span style="color:#b39f04;">as_ref</span><span>();
</span><span>	
</span><span>    </span><span style="color:#7f8989;">// weird =(, but less code
</span><span>    </span><span style="color:#668f14;">let</span><span> pp_query </span><span style="color:#72ab00;">= crate</span><span>::lingua::preprocess(</span><span style="color:#a2a001;">vec!</span><span>[(</span><span style="color:#b3933a;">0</span><span>, </span><span style="color:#a2a001;">vec!</span><span>[obj.text.</span><span style="color:#b39f04;">clone</span><span>()])]);
</span><span>    </span><span style="color:#668f14;">let</span><span> preprocessed_text </span><span style="color:#72ab00;">=</span><span> pp_query
</span><span>        .</span><span style="color:#b39f04;">get</span><span>(</span><span style="color:#b3933a;">0</span><span>)
</span><span>        .</span><span style="color:#b39f04;">expect</span><span>(</span><span style="color:#d07711;">&quot;valid search text&quot;</span><span>)
</span><span>        .</span><span style="color:#b3933a;">1
</span><span>        .</span><span style="color:#b39f04;">get</span><span>(</span><span style="color:#b3933a;">0</span><span>)
</span><span>        .</span><span style="color:#b39f04;">expect</span><span>(</span><span style="color:#d07711;">&quot;query shouldn&#39;t be deleted&quot;</span><span>);
</span><span>
</span><span>
</span><span>    </span><span style="color:#668f14;">let mut</span><span> res </span><span style="color:#72ab00;">= </span><span style="color:#a2a001;">vec!</span><span>[];
</span><span>    state.</span><span style="color:#b39f04;">inner</span><span>().indexed_goods.</span><span style="color:#b39f04;">get</span><span>(</span><span style="color:#72ab00;">&amp;</span><span>obj.text).</span><span style="color:#b39f04;">map</span><span>(|</span><span style="color:#5597d6;">ids</span><span>| {
</span><span>        ids.</span><span style="color:#b39f04;">iter</span><span>().</span><span style="color:#b39f04;">for_each</span><span>(|</span><span style="color:#5597d6;">id</span><span>| {
</span><span>            res.</span><span style="color:#b39f04;">push</span><span>(
</span><span>                goods
</span><span>                    .</span><span style="color:#b39f04;">get</span><span>(</span><span style="color:#72ab00;">*</span><span>id)
</span><span>                    .</span><span style="color:#b39f04;">expect</span><span>(</span><span style="color:#72ab00;">&amp;</span><span style="color:#a2a001;">format!</span><span>(</span><span style="color:#d07711;">&quot;doc with id=</span><span style="color:#aeb52b;">{}</span><span style="color:#d07711;"> should be presented&quot;</span><span>, id)),
</span><span>            )
</span><span>        })
</span><span>    });
</span><span>
</span><span>    </span><span style="color:#a2a001;">json!</span><span>(res)
</span><span>}
</span></code></pre>
<p>In order to see &quot;fast&quot; requests results we also need to modify UI:</p>
<pre data-lang="rust" style="background-color:#f5f5f5;color:#1f1f1f;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#7f8989;">// src/ui.rs
</span><span>
</span><span style="color:#7f8989;">// in fn update():
</span><span>
</span><span style="color:#72ab00;">- </span><span style="color:#7f8989;">// disabled for a while
</span><span style="color:#72ab00;">- </span><span style="color:#7f8989;">// Msg::FoundFast(
</span><span style="color:#72ab00;">- </span><span style="color:#7f8989;">//     serde_json::from_slice(
</span><span style="color:#72ab00;">- </span><span style="color:#7f8989;">//         &amp;response.body().as_ref().unwrap().as_bytes(),
</span><span style="color:#72ab00;">- </span><span style="color:#7f8989;">//     )
</span><span style="color:#72ab00;">- </span><span style="color:#7f8989;">//     .unwrap(),
</span><span style="color:#72ab00;">- </span><span style="color:#7f8989;">// )
</span><span style="color:#72ab00;">- </span><span>Msg::FoundFast(</span><span style="color:#a2a001;">vec!</span><span>[])
</span><span style="color:#72ab00;">+ </span><span>Msg::FoundFast(
</span><span style="color:#72ab00;">+     </span><span>serde_json::from_slice(
</span><span style="color:#72ab00;">+         &amp;</span><span>response.</span><span style="color:#b39f04;">body</span><span>().</span><span style="color:#b39f04;">as_ref</span><span>().</span><span style="color:#b39f04;">unwrap</span><span>().</span><span style="color:#b39f04;">as_bytes</span><span>(),
</span><span style="color:#72ab00;">+     </span><span>)
</span><span style="color:#72ab00;">+     </span><span>.</span><span style="color:#b39f04;">unwrap</span><span>(),
</span><span style="color:#72ab00;">+ </span><span>)
</span><span>
</span><span>
</span><span>Msg::FoundFast(items) </span><span style="color:#72ab00;">=&gt; </span><span>{
</span><span style="color:#72ab00;">-    </span><span style="color:#5597d6;">self</span><span>.found_items_slow </span><span style="color:#72ab00;">=</span><span> items;
</span><span style="color:#72ab00;">-    </span><span style="color:#7f8989;">// self.request_time_fast_diff_secs =
</span><span style="color:#72ab00;">-    </span><span style="color:#7f8989;">//     (instant::now() - self.requests_start_time) / 1000.0;
</span><span style="color:#72ab00;">+    </span><span style="color:#5597d6;">self</span><span>.found_items_fast </span><span style="color:#72ab00;">=</span><span> items;
</span><span style="color:#72ab00;">+    </span><span style="color:#5597d6;">self</span><span>.request_time_fast_diff_secs </span><span style="color:#72ab00;">=
</span><span style="color:#72ab00;">+	     </span><span>(instant::now() </span><span style="color:#72ab00;">- </span><span style="color:#5597d6;">self</span><span>.requests_start_time) </span><span style="color:#72ab00;">/ </span><span style="color:#b3933a;">1000.0</span><span>;
</span><span>     }
</span></code></pre>
<p>Run our query again: </p>
<p><img src="../myox_ftse_fast.png" alt="fast request" /></p>
<p>Cool!</p>
<p>There are a lot of other questions:</p>
<ul>
<li>how to persist indexes</li>
<li>how to rank results</li>
<li>how to query against complex phrases</li>
<li>different types of docs indexing</li>
<li>possibility to handle multiple languages</li>
<li>etc</li>
</ul>
<p>Maybe I'll come back to this questions in the future, but i think it's enough for now.</p>
<p>I hope that this was usefull!<br />
Good luck!</p>

        </div>
    </div>

    </div>

  <body>
  </body>
</html>
